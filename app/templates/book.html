{% extends "base.html" %}

{% block content %}
<h1 class="mb-3">Book: {{ room.name }}</h1>

<div class="row align-items-start g-4 mb-4">
  <!-- Details + form column (left on desktop, top on mobile) -->
  <div class="col-md-7 order-2 order-md-1">

    <!-- Room description & price -->
    <p class="lead mb-2">{{ room.description }}</p>
    <h4 class="text-primary mb-3">
      £{{ "%.2f"|format(room.price) }} per night
    </h4>

    <!-- Change-room button -->
    <a href="{{ url_for('main.index') }}"
      class="btn btn--pink-outline mb-4">
      ← Choose a different room
    </a>

    <!-- START Booking form (moved up, no white space) -->
    <form method="post" novalidate aria-label="Booking form">
      {{ form.csrf_token }}

      <div class="row g-3">
        <!-- Check-in -->
        <div class="col-sm-4">
          <label class="form-label"
                 for="{{ form.start_date.id }}">Check-in</label>
          {{ form.start_date(class="form-control") }}
        </div>

        <!-- Check-out -->
        <div class="col-sm-4">
          <label class="form-label"
                 for="{{ form.end_date.id }}">Check-out</label>
          {{ form.end_date(class="form-control") }}

          <!-- Night-count buttons -->
          <div class="btn-group mt-2" role="group" aria-label="Quick nights">
            <button type="button" class="btn btn--pink-soft js-nights is-selected" data-nights="1">1 night</button>
            <button type="button" class="btn btn--pink-soft js-nights"             data-nights="2">2 nights</button>
            <button type="button" class="btn btn--pink-soft js-nights"             data-nights="3">3 nights</button>
          </div>
        </div>

        <!-- Guests -->
        <div class="col-sm-4">
          <label class="form-label">Guests</label>
          <!-- Hidden field (keeps WTForms validation) -->
          {{ form.guests(type="hidden") }}

          <div class="btn-group d-flex" role="group" aria-label="Guest count">
            {% for g in [1,2,3,4,5] %}
              <button type="button"
                      class="btn btn--pink-outline guest-btn flex-fill"
                      data-count="{{ g }}">
                {{ g }}
              </button>
            {% endfor %}
            <button type="button"
                    class="btn btn--pink-outline guest-btn flex-fill"
                    data-count="6">
              5+
            </button>
          </div>

        </div>

        <div class="col-12">
          {{ form.submit(class="btn btn--pink mt-3") }}
        </div>
      </div>
    </form>
    <!-- END Booking form -->
  </div>

  <!-- Image column (right on desktop) -->
  <div class="col-md-5 order-1 order-md-2 text-center">
    <img src="{{ url_for('static', filename=room.image_url) }}"
         alt="{{ room.name }} image"
         class="img-fluid rounded shadow-sm w-100">
  </div>
</div>

<script>
/* Guest buttons */
document.querySelectorAll(".guest-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const count = btn.dataset.count;
    /* update hidden WTForms field */
    document.getElementById("{{ form.guests.id }}").value = count;

    /* visual selection */
    btn.parentElement.querySelectorAll(".guest-btn")
       .forEach(b => b.classList.remove("is-selected"));
    btn.classList.add("is-selected");
  });
});

/* Night buttons  */
const startInput = document.getElementById("{{ form.start_date.id }}");
const endInput   = document.getElementById("{{ form.end_date.id }}");

function setCheckout(nights) {
  const start = new Date(startInput.value);
  if (!isNaN(start)) {
    const checkout = new Date(start);
    checkout.setDate(start.getDate() + nights);
    endInput.valueAsDate = checkout;
  }
}

/* update end date whenever check-in changes */
startInput.addEventListener("change", () => {
  const sel = document.querySelector(".js-nights.is-selected");
  const nights = sel ? parseInt(sel.dataset.nights) : 1;
  setCheckout(nights);
});

document.querySelectorAll(".js-nights").forEach(btn => {
  btn.addEventListener("click", () => {
    /* visual toggle */
    btn.parentElement.querySelectorAll(".js-nights")
       .forEach(b => b.classList.remove("is-selected"));
    btn.classList.add("is-selected");

    /* date logic */
    setCheckout(parseInt(btn.dataset.nights));
  });
});

/* Default: if endDate empty, set to +1 night on page load */
window.addEventListener("DOMContentLoaded", () => {
  const sel = document.querySelector(".js-nights.is-selected");
  const nights = sel ? parseInt(sel.dataset.nights) : 1;
  if (!endInput.value) setCheckout(nights);
});




</script>


{% endblock %}
